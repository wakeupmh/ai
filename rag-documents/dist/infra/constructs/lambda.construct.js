"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.makeLambda = void 0;
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const aws_lambda_1 = require("aws-cdk-lib/aws-lambda");
const aws_lambda_nodejs_1 = require("aws-cdk-lib/aws-lambda-nodejs");
const aws_logs_1 = require("aws-cdk-lib/aws-logs");
const path = require("path");
const config_1 = require("../config");
class Lambda extends aws_lambda_nodejs_1.NodejsFunction {
    constructor(scope, id, props) {
        const config = (0, config_1.makeConfig)();
        const isProd = config.envName === 'prod';
        const environmentVariables = props.environmentVariables || {};
        const layers = (props.layers || []);
        // https://docs.powertools.aws.dev/lambda/typescript/latest/#environment-variables
        const powertoolsLayer = aws_lambda_1.LayerVersion.fromLayerVersionArn(scope, `${id}-powertools-layer`, `arn:aws:lambda:${config.region}:094274105915:layer:AWSLambdaPowertoolsTypeScript:16`);
        layers.push(powertoolsLayer);
        if (props.useSharedVpc) {
            props.overwrite = {
                ...props.overwrite,
                vpc: props.resourcesStack.sharedVpc,
                securityGroups: [props.resourcesStack.sharedVpcSg],
            };
        }
        const lambdaProps = {
            functionName: `${config.serviceName}-${props.name}`,
            entry: path.join(__dirname, '..', '..', 'src', 'functions', props.entry),
            description: props.description,
            timeout: aws_cdk_lib_1.Duration.seconds(300),
            runtime: aws_lambda_1.Runtime.NODEJS_18_X,
            architecture: aws_lambda_1.Architecture.ARM_64,
            tracing: aws_lambda_1.Tracing.ACTIVE,
            logRetention: isProd ? aws_logs_1.RetentionDays.ONE_YEAR : aws_logs_1.RetentionDays.ONE_WEEK,
            environment: {
                ENV_NAME: config.envName,
                AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1',
                POWERTOOLS_SERVICE_NAME: config.serviceName,
                POWERTOOLS_METRICS_NAMESPACE: config.projectName,
                OBSERVABILITY_LOGGER_ENABLED: config.observability.logger.enabled.toString(),
                OBSERVABILITY_LOGGER_LEVEL: config.observability.logger.level,
                OBSERVABILITY_METRICS_ENABLED: config.observability.metrics.enabled.toString(),
                OBSERVABILITY_TRACER_ENABLED: config.observability.tracer.enabled.toString(),
                ...environmentVariables,
            },
            bundling: {
                minify: true,
                sourceMap: false,
                target: 'es2021',
                logLevel: aws_lambda_nodejs_1.LogLevel.ERROR,
                loader: {
                    ".node": "file",
                },
                externalModules: [
                    '@aws-lambda-powertools/commons',
                    '@aws-lambda-powertools/logger',
                    '@aws-lambda-powertools/tracer',
                    '@aws-lambda-powertools/metrics',
                ],
            },
            memorySize: config.defaultMemorySize,
            layers,
            ...(props.overwrite || {}),
        };
        super(scope, id, lambdaProps);
        this.config = config;
    }
}
const makeLambda = (scope, id, props) => {
    const config = props.resourcesStack.config;
    const lambda = new Lambda(scope, id, props);
    if (props.resourcesStack.secret) {
        props.resourcesStack.secret.grantRead(lambda);
    }
    if (props.useDynamo) {
        props.tables = [...(props.tables || []), props.resourcesStack.table, props.resourcesStack.tableIndexes];
    }
    for (const table of props?.tables || []) {
        table.grantReadWriteData(lambda);
    }
    for (const topic of props?.topics || []) {
        topic.grantPublish(lambda);
    }
    for (const bucket of props?.buckets || []) {
        bucket.grantReadWrite(lambda);
    }
    if (props?.queues || props.allowQueueAccess) {
        lambda.addToRolePolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            actions: ['sqs:*'],
            resources: ['*'],
        }));
    }
    if (props?.useSes) {
        lambda.addToRolePolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            actions: ['ses:SendRawEmail', 'ses:GetTemplate', 'ses:SendTemplatedEmail'],
            resources: ['*'],
        }));
    }
    if (props?.userPools) {
        lambda.addToRolePolicy(new aws_iam_1.PolicyStatement({
            effect: aws_iam_1.Effect.ALLOW,
            actions: ['cognito-idp:*'],
            resources: ['*'],
        }));
    }
    new aws_cdk_lib_1.CfnOutput(lambda, `${config.serviceName}-${id}-output-arn`, {
        value: lambda.functionArn,
        exportName: `${config.serviceName}::function::${props.name}::arn`,
    });
    new aws_lambda_1.CfnPermission(lambda, `${config.serviceName}-${id}-lambda-permission`, {
        action: 'lambda:InvokeFunction',
        functionName: lambda.functionName,
        principal: 'apigateway.amazonaws.com',
    });
    return lambda;
};
exports.makeLambda = makeLambda;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFtYmRhLmNvbnN0cnVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2luZnJhL2NvbnN0cnVjdHMvbGFtYmRhLmNvbnN0cnVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw2Q0FBaUQ7QUFHakQsaURBQTZEO0FBQzdELHVEQUFtSDtBQUNuSCxxRUFBNkY7QUFDN0YsbURBQW9EO0FBTXBELDZCQUE2QjtBQUU3QixzQ0FBdUQ7QUE0QnZELE1BQU0sTUFBTyxTQUFRLGtDQUFjO0lBR2pDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBa0I7UUFDMUQsTUFBTSxNQUFNLEdBQUcsSUFBQSxtQkFBVSxHQUFFLENBQUE7UUFDM0IsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sS0FBSyxNQUFNLENBQUE7UUFFeEMsTUFBTSxvQkFBb0IsR0FBRyxLQUFLLENBQUMsb0JBQW9CLElBQUksRUFBRSxDQUFBO1FBRTdELE1BQU0sTUFBTSxHQUFHLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQW9CLENBQUE7UUFFdEQsa0ZBQWtGO1FBQ2xGLE1BQU0sZUFBZSxHQUFHLHlCQUFZLENBQUMsbUJBQW1CLENBQ3RELEtBQUssRUFDTCxHQUFHLEVBQUUsbUJBQW1CLEVBQ3hCLGtCQUFrQixNQUFNLENBQUMsTUFBTSxzREFBc0QsQ0FDdEYsQ0FBQTtRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUE7UUFFNUIsSUFBSSxLQUFLLENBQUMsWUFBWSxFQUFFO1lBQ3RCLEtBQUssQ0FBQyxTQUFTLEdBQUc7Z0JBQ2hCLEdBQUcsS0FBSyxDQUFDLFNBQVM7Z0JBQ2xCLEdBQUcsRUFBRSxLQUFLLENBQUMsY0FBYyxDQUFDLFNBQVM7Z0JBQ25DLGNBQWMsRUFBRSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDO2FBQ25ELENBQUE7U0FDRjtRQUVELE1BQU0sV0FBVyxHQUF3QjtZQUN2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dUJBQVMsQ0FBQyxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsV0FBVyxJQUFJLEVBQUUsYUFBYSxFQUFFO1FBQzlELEtBQUssRUFBRSxNQUFNLENBQUMsV0FBVztRQUN6QixVQUFVLEVBQUUsR0FBRyxNQUFNLENBQUMsV0FBVyxlQUFlLEtBQUssQ0FBQyxJQUFJLE9BQU87S0FDbEUsQ0FBQyxDQUFBO0lBRUYsSUFBSSwwQkFBYSxDQUFDLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxXQUFXLElBQUksRUFBRSxvQkFBb0IsRUFBRTtRQUN6RSxNQUFNLEVBQUUsdUJBQXVCO1FBQy9CLFlBQVksRUFBRSxNQUFNLENBQUMsWUFBWTtRQUNqQyxTQUFTLEVBQUUsMEJBQTBCO0tBQ3RDLENBQUMsQ0FBQTtJQUVGLE9BQU8sTUFBTSxDQUFBO0FBQ2YsQ0FBQyxDQUFBO0FBbEVZLFFBQUEsVUFBVSxjQWtFdEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDZm5PdXRwdXQsIER1cmF0aW9uIH0gZnJvbSAnYXdzLWNkay1saWInXG5pbXBvcnQgeyBJVXNlclBvb2wgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtY29nbml0bydcbmltcG9ydCB7IElUYWJsZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1keW5hbW9kYidcbmltcG9ydCB7IEVmZmVjdCwgUG9saWN5U3RhdGVtZW50IH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSdcbmltcG9ydCB7IEFyY2hpdGVjdHVyZSwgQ2ZuUGVybWlzc2lvbiwgSUxheWVyVmVyc2lvbiwgTGF5ZXJWZXJzaW9uLCBSdW50aW1lLCBUcmFjaW5nIH0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWxhbWJkYSdcbmltcG9ydCB7IExvZ0xldmVsLCBOb2RlanNGdW5jdGlvbiwgTm9kZWpzRnVuY3Rpb25Qcm9wcyB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEtbm9kZWpzJ1xuaW1wb3J0IHsgUmV0ZW50aW9uRGF5cyB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sb2dzJ1xuaW1wb3J0IHsgSUJ1Y2tldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMydcbmltcG9ydCB7IElUb3BpYyB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zbnMnXG5pbXBvcnQgeyBJUXVldWUgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc3FzJ1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cydcblxuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcblxuaW1wb3J0IHsgQ29uZmlnSW50ZXJmYWNlLCBtYWtlQ29uZmlnIH0gZnJvbSAnLi4vY29uZmlnJ1xuaW1wb3J0IHsgUmVzb3VyY2VzU3RhY2sgfSBmcm9tICcuLi9zdGFja3MvcmVzb3VyY2VzLnN0YWNrJ1xuXG5leHBvcnQgaW50ZXJmYWNlIExhbWJkYVByb3BzIHtcbiAgbmFtZTogc3RyaW5nXG4gIGVudHJ5OiBzdHJpbmdcbiAgZGVzY3JpcHRpb246IHN0cmluZ1xuICByZXNvdXJjZXNTdGFjazogUmVzb3VyY2VzU3RhY2tcbiAgdGFibGVzPzogSVRhYmxlW11cbiAgdG9waWNzPzogSVRvcGljW11cbiAgcXVldWVzPzogSVF1ZXVlW11cbiAgYnVja2V0cz86IElCdWNrZXRbXVxuICB1c2VyUG9vbHM/OiBJVXNlclBvb2xbXVxuICBlbnZpcm9ubWVudFZhcmlhYmxlcz86IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH1cbiAgaXNFeHRlcm5hbD86IGJvb2xlYW5cbiAgaXNvbGF0ZWQ/OiBib29sZWFuXG4gIGxheWVycz86IElMYXllclZlcnNpb25bXVxuICBvdmVyd3JpdGU/OiBOb2RlanNGdW5jdGlvblByb3BzXG4gIHVzZUR5bmFtbz86IGJvb2xlYW5cbiAgdXNlU2VzPzogYm9vbGVhblxuICBhdWRpdFRhZ3M6IHtcbiAgICBjb250YWluc1VzZXJEYXRhOiBib29sZWFuXG4gICAgdXNlckRhdGFTdG9yZWQ/OiBzdHJpbmdcbiAgfVxuICB1c2VTaGFyZWRWcGM/OiBib29sZWFuXG4gIGFsbG93UXVldWVBY2Nlc3M/OiBib29sZWFuXG59XG5cbmNsYXNzIExhbWJkYSBleHRlbmRzIE5vZGVqc0Z1bmN0aW9uIHtcbiAgcHJvdGVjdGVkIGNvbmZpZzogQ29uZmlnSW50ZXJmYWNlXG5cbiAgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IExhbWJkYVByb3BzKSB7XG4gICAgY29uc3QgY29uZmlnID0gbWFrZUNvbmZpZygpXG4gICAgY29uc3QgaXNQcm9kID0gY29uZmlnLmVudk5hbWUgPT09ICdwcm9kJ1xuXG4gICAgY29uc3QgZW52aXJvbm1lbnRWYXJpYWJsZXMgPSBwcm9wcy5lbnZpcm9ubWVudFZhcmlhYmxlcyB8fCB7fVxuXG4gICAgY29uc3QgbGF5ZXJzID0gKHByb3BzLmxheWVycyB8fCBbXSkgYXMgSUxheWVyVmVyc2lvbltdXG5cbiAgICAvLyBodHRwczovL2RvY3MucG93ZXJ0b29scy5hd3MuZGV2L2xhbWJkYS90eXBlc2NyaXB0L2xhdGVzdC8jZW52aXJvbm1lbnQtdmFyaWFibGVzXG4gICAgY29uc3QgcG93ZXJ0b29sc0xheWVyID0gTGF5ZXJWZXJzaW9uLmZyb21MYXllclZlcnNpb25Bcm4oXG4gICAgICBzY29wZSxcbiAgICAgIGAke2lkfS1wb3dlcnRvb2xzLWxheWVyYCxcbiAgICAgIGBhcm46YXdzOmxhbWJkYToke2NvbmZpZy5yZWdpb259OjA5NDI3NDEwNTkxNTpsYXllcjpBV1NMYW1iZGFQb3dlcnRvb2xzVHlwZVNjcmlwdDoxNmAsXG4gICAgKVxuICAgIGxheWVycy5wdXNoKHBvd2VydG9vbHNMYXllcilcblxuICAgIGlmIChwcm9wcy51c2VTaGFyZWRWcGMpIHtcbiAgICAgIHByb3BzLm92ZXJ3cml0ZSA9IHtcbiAgICAgICAgLi4ucHJvcHMub3ZlcndyaXRlLFxuICAgICAgICB2cGM6IHByb3BzLnJlc291cmNlc1N0YWNrLnNoYXJlZFZwYyxcbiAgICAgICAgc2VjdXJpdHlHcm91cHM6IFtwcm9wcy5yZXNvdXJjZXNTdGFjay5zaGFyZWRWcGNTZ10sXG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgbGFtYmRhUHJvcHM6IE5vZGVqc0Z1bmN0aW9uUHJvcHMgPSB7XG4gICAgICBmdW5jdGlvbk5hbWU6IGAke2NvbmZpZy5zZXJ2aWNlTmFtZX0tJHtwcm9wcy5uYW1lfWAsXG4gICAgICBlbnRyeTogcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJ3NyYycsICdmdW5jdGlvbnMnLCBwcm9wcy5lbnRyeSksXG4gICAgICBkZXNjcmlwdGlvbjogcHJvcHMuZGVzY3JpcHRpb24sXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5zZWNvbmRzKDMwMCksXG4gICAgICBydW50aW1lOiBSdW50aW1lLk5PREVKU18xOF9YLFxuICAgICAgYXJjaGl0ZWN0dXJlOiBBcmNoaXRlY3R1cmUuQVJNXzY0LFxuICAgICAgdHJhY2luZzogVHJhY2luZy5BQ1RJVkUsXG4gICAgICBsb2dSZXRlbnRpb246IGlzUHJvZCA/IFJldGVudGlvbkRheXMuT05FX1lFQVIgOiBSZXRlbnRpb25EYXlzLk9ORV9XRUVLLFxuICAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAgICAgRU5WX05BTUU6IGNvbmZpZy5lbnZOYW1lLFxuICAgICAgICBBV1NfTk9ERUpTX0NPTk5FQ1RJT05fUkVVU0VfRU5BQkxFRDogJzEnLFxuICAgICAgICBQT1dFUlRPT0xTX1NFUlZJQ0VfTkFNRTogY29uZmlnLnNlcnZpY2VOYW1lLFxuICAgICAgICBQT1dFUlRPT0xTX01FVFJJQ1NfTkFNRVNQQUNFOiBjb25maWcucHJvamVjdE5hbWUsXG4gICAgICAgIE9CU0VSVkFCSUxJVFlfTE9HR0VSX0VOQUJMRUQ6IGNvbmZpZy5vYnNlcnZhYmlsaXR5LmxvZ2dlci5lbmFibGVkLnRvU3RyaW5nKCksXG4gICAgICAgIE9CU0VSVkFCSUxJVFlfTE9HR0VSX0xFVkVMOiBjb25maWcub2JzZXJ2YWJpbGl0eS5sb2dnZXIubGV2ZWwsXG4gICAgICAgIE9CU0VSVkFCSUxJVFlfTUVUUklDU19FTkFCTEVEOiBjb25maWcub2JzZXJ2YWJpbGl0eS5tZXRyaWNzLmVuYWJsZWQudG9TdHJpbmcoKSxcbiAgICAgICAgT0JTRVJWQUJJTElUWV9UUkFDRVJfRU5BQkxFRDogY29uZmlnLm9ic2VydmFiaWxpdHkudHJhY2VyLmVuYWJsZWQudG9TdHJpbmcoKSxcbiAgICAgICAgLi4uZW52aXJvbm1lbnRWYXJpYWJsZXMsXG4gICAgICB9LFxuICAgICAgYnVuZGxpbmc6IHtcbiAgICAgICAgbWluaWZ5OiB0cnVlLCAvLyBtaW5pZnkgY29kZSwgZGVmYXVsdHMgdG8gZmFsc2VcbiAgICAgICAgc291cmNlTWFwOiBmYWxzZSwgLy8gaW5jbHVkZSBzb3VyY2UgbWFwLCBkZWZhdWx0cyB0byBmYWxzZVxuICAgICAgICB0YXJnZXQ6ICdlczIwMjEnLCAvLyB0YXJnZXQgZW52aXJvbm1lbnQgZm9yIHRoZSBnZW5lcmF0ZWQgSmF2YVNjcmlwdCBjb2RlXG4gICAgICAgIGxvZ0xldmVsOiBMb2dMZXZlbC5FUlJPUixcbiAgICAgICAgbG9hZGVyOiB7XG4gICAgICAgICAgXCIubm9kZVwiOiBcImZpbGVcIixcbiAgICAgICAgfSxcbiAgICAgICAgZXh0ZXJuYWxNb2R1bGVzOiBbXG4gICAgICAgICAgJ0Bhd3MtbGFtYmRhLXBvd2VydG9vbHMvY29tbW9ucycsXG4gICAgICAgICAgJ0Bhd3MtbGFtYmRhLXBvd2VydG9vbHMvbG9nZ2VyJyxcbiAgICAgICAgICAnQGF3cy1sYW1iZGEtcG93ZXJ0b29scy90cmFjZXInLFxuICAgICAgICAgICdAYXdzLWxhbWJkYS1wb3dlcnRvb2xzL21ldHJpY3MnLFxuICAgICAgICBdLFxuICAgICAgfSxcbiAgICAgIG1lbW9yeVNpemU6IGNvbmZpZy5kZWZhdWx0TWVtb3J5U2l6ZSxcbiAgICAgIGxheWVycyxcbiAgICAgIC4uLihwcm9wcy5vdmVyd3JpdGUgfHwge30pLFxuICAgIH1cblxuICAgIHN1cGVyKHNjb3BlLCBpZCwgbGFtYmRhUHJvcHMpXG4gICAgdGhpcy5jb25maWcgPSBjb25maWdcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgbWFrZUxhbWJkYSA9IChzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogTGFtYmRhUHJvcHMpID0+IHtcbiAgY29uc3QgY29uZmlnID0gcHJvcHMucmVzb3VyY2VzU3RhY2suY29uZmlnXG4gIGNvbnN0IGxhbWJkYSA9IG5ldyBMYW1iZGEoc2NvcGUsIGlkLCBwcm9wcylcblxuICBpZiAocHJvcHMucmVzb3VyY2VzU3RhY2suc2VjcmV0KSB7XG4gICAgcHJvcHMucmVzb3VyY2VzU3RhY2suc2VjcmV0LmdyYW50UmVhZChsYW1iZGEpXG4gIH1cblxuICBpZiAocHJvcHMudXNlRHluYW1vKSB7XG4gICAgcHJvcHMudGFibGVzID0gWy4uLihwcm9wcy50YWJsZXMgfHwgW10pLCBwcm9wcy5yZXNvdXJjZXNTdGFjay50YWJsZSwgcHJvcHMucmVzb3VyY2VzU3RhY2sudGFibGVJbmRleGVzXVxuICB9XG5cbiAgZm9yIChjb25zdCB0YWJsZSBvZiBwcm9wcz8udGFibGVzIHx8IFtdKSB7XG4gICAgdGFibGUuZ3JhbnRSZWFkV3JpdGVEYXRhKGxhbWJkYSlcbiAgfVxuXG4gIGZvciAoY29uc3QgdG9waWMgb2YgcHJvcHM/LnRvcGljcyB8fCBbXSkge1xuICAgIHRvcGljLmdyYW50UHVibGlzaChsYW1iZGEpXG4gIH1cblxuICBmb3IgKGNvbnN0IGJ1Y2tldCBvZiBwcm9wcz8uYnVja2V0cyB8fCBbXSkge1xuICAgIGJ1Y2tldC5ncmFudFJlYWRXcml0ZShsYW1iZGEpXG4gIH1cblxuICBpZiAocHJvcHM/LnF1ZXVlcyB8fCBwcm9wcy5hbGxvd1F1ZXVlQWNjZXNzKSB7XG4gICAgbGFtYmRhLmFkZFRvUm9sZVBvbGljeShcbiAgICAgIG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogWydzcXM6KiddLFxuICAgICAgICByZXNvdXJjZXM6IFsnKiddLFxuICAgICAgfSksXG4gICAgKVxuICB9XG5cbiAgaWYgKHByb3BzPy51c2VTZXMpIHtcbiAgICBsYW1iZGEuYWRkVG9Sb2xlUG9saWN5KFxuICAgICAgbmV3IFBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgIGVmZmVjdDogRWZmZWN0LkFMTE9XLFxuICAgICAgICBhY3Rpb25zOiBbJ3NlczpTZW5kUmF3RW1haWwnLCAnc2VzOkdldFRlbXBsYXRlJywgJ3NlczpTZW5kVGVtcGxhdGVkRW1haWwnXSxcbiAgICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgIH0pLFxuICAgIClcbiAgfVxuXG4gIGlmIChwcm9wcz8udXNlclBvb2xzKSB7XG4gICAgbGFtYmRhLmFkZFRvUm9sZVBvbGljeShcbiAgICAgIG5ldyBQb2xpY3lTdGF0ZW1lbnQoe1xuICAgICAgICBlZmZlY3Q6IEVmZmVjdC5BTExPVyxcbiAgICAgICAgYWN0aW9uczogWydjb2duaXRvLWlkcDoqJ10sXG4gICAgICAgIHJlc291cmNlczogWycqJ10sXG4gICAgICB9KSxcbiAgICApXG4gIH1cblxuICBuZXcgQ2ZuT3V0cHV0KGxhbWJkYSwgYCR7Y29uZmlnLnNlcnZpY2VOYW1lfS0ke2lkfS1vdXRwdXQtYXJuYCwge1xuICAgIHZhbHVlOiBsYW1iZGEuZnVuY3Rpb25Bcm4sXG4gICAgZXhwb3J0TmFtZTogYCR7Y29uZmlnLnNlcnZpY2VOYW1lfTo6ZnVuY3Rpb246OiR7cHJvcHMubmFtZX06OmFybmAsXG4gIH0pXG5cbiAgbmV3IENmblBlcm1pc3Npb24obGFtYmRhLCBgJHtjb25maWcuc2VydmljZU5hbWV9LSR7aWR9LWxhbWJkYS1wZXJtaXNzaW9uYCwge1xuICAgIGFjdGlvbjogJ2xhbWJkYTpJbnZva2VGdW5jdGlvbicsXG4gICAgZnVuY3Rpb25OYW1lOiBsYW1iZGEuZnVuY3Rpb25OYW1lLFxuICAgIHByaW5jaXBhbDogJ2FwaWdhdGV3YXkuYW1hem9uYXdzLmNvbScsXG4gIH0pXG5cbiAgcmV0dXJuIGxhbWJkYVxufVxuIl19